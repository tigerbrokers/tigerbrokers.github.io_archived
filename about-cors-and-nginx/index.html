
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="TigerFED">
    <title>有关跨域 CORS 及 Nginx 配置 - TigerFED - 老虎证券桌面技术团队博客</title>
    <meta name="author" content="TigerFED">
    
        <meta name="keywords" content="cors,nginx,http">
    
    
        <link rel="icon" href="http://tigerbrokers.github.io/assets/images/assets/images/favicon.ico">
    
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="manifest" href="/assets/site.webmanifest">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="跨域请求针对浏览器的同源策略(Same-Origin Policy)而言，指一个网站主动请求另外一个网站的资源(图片、javascript、视频等)。 同源策略要求网站只能有限制的访问外部网站的资源，不合法的请求会被拦截。网站的源由协议、域名、端口三部分组成，有一部分不同就被视为不同源，两个不同的域名即便指向同一个ip地址也是跨域的。网站通过AJAX请求资源是典型的跨域请求，需要外部网站许可才能访">
<meta name="keywords" content="cors,nginx,http">
<meta property="og:type" content="blog">
<meta property="og:title" content="有关跨域 CORS 及 Nginx 配置">
<meta property="og:url" content="http://tigerbrokers.github.io/about-cors-and-nginx/index.html">
<meta property="og:site_name" content="TigerFED">
<meta property="og:description" content="跨域请求针对浏览器的同源策略(Same-Origin Policy)而言，指一个网站主动请求另外一个网站的资源(图片、javascript、视频等)。 同源策略要求网站只能有限制的访问外部网站的资源，不合法的请求会被拦截。网站的源由协议、域名、端口三部分组成，有一部分不同就被视为不同源，两个不同的域名即便指向同一个ip地址也是跨域的。网站通过AJAX请求资源是典型的跨域请求，需要外部网站许可才能访">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="http://tigerbrokers.github.io/assets/images/15178986212867.jpg">
<meta property="og:image" content="http://tigerbrokers.github.io/assets/images/15178986972043.jpg">
<meta property="og:image" content="http://tigerbrokers.github.io/assets/images/15178987236463.jpg">
<meta property="og:image" content="http://tigerbrokers.github.io/assets/images/15178987563714.jpg">
<meta property="og:image" content="http://tigerbrokers.github.io/assets/images/15179074088703.jpg">
<meta property="og:image" content="http://tigerbrokers.github.io/assets/images/15179075649303.jpg">
<meta property="og:updated_time" content="2018-02-07T08:52:13.675Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="有关跨域 CORS 及 Nginx 配置">
<meta name="twitter:description" content="跨域请求针对浏览器的同源策略(Same-Origin Policy)而言，指一个网站主动请求另外一个网站的资源(图片、javascript、视频等)。 同源策略要求网站只能有限制的访问外部网站的资源，不合法的请求会被拦截。网站的源由协议、域名、端口三部分组成，有一部分不同就被视为不同源，两个不同的域名即便指向同一个ip地址也是跨域的。网站通过AJAX请求资源是典型的跨域请求，需要外部网站许可才能访">
<meta name="twitter:image" content="http://tigerbrokers.github.io/assets/images/15178986212867.jpg">
    
    
        
    
    
        <meta property="og:image" content="http://tigerbrokers.github.io/assets/images/tfed.png"/>
    
    
    
        <meta property="og:image" content="http://tigerbrokers.github.io/about-cors-and-nginx/assets/images/mike-bryant-75071.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="http://tigerbrokers.github.io/about-cors-and-nginx/assets/images/mike-bryant-75071.jpg" />
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-vzs5hoi7flzbzwib30bkywiwz5f9xvj5omo6bm602dub3njoxug7nd0bjqdq.min.css">
    <!--STYLES END-->
    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">TigerFED</a>
    </div>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="/assets/images/tfed.png" alt="作者的图片"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/tfed.png" alt="作者的图片"/>
                </a>
                <h4 class="sidebar-profile-name">TigerFED</h4>
                
                    <h5 class="sidebar-profile-bio"><p>老虎证券桌面团队博客</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                            title="首页"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/tags"
                            
                            title="标签"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="#about"
                            
                            title="关于"
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/tigerbrokers" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://www.itiger.com" target="_blank" rel="noopener" title="老虎证券">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-link" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">老虎证券</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
        <div class="post-header-cover
                    text-left
                    post-header-cover--partial"
             style="background-image:url('/assets/images/mike-bryant-75071.jpg');"
             data-behavior="4">
            
                <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            有关跨域 CORS 及 Nginx 配置
        </h1>
    
    
        <div class="post-meta">
    <time itemprop="datePublished" datetime="2018-02-06T06:28:58+00:00">
	
		    2018-02-06
    	
    </time>
    

    
      <span>作者: ijse </span>
    

</div>

    
</div>
            
        </div>


            <div id="main" data-behavior="4"
                 class="hasCover
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
    
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <!-- excerpt --></p>
<h1 id="什么是跨域？"><a href="#什么是跨域？" class="headerlink" title="什么是跨域？"></a>什么是跨域？</h1><p>跨域请求针对浏览器的同源策略(Same-Origin Policy)而言，指一个网站主动请求另外一个网站的资源(图片、javascript、视频等)。</p>
<p>同源策略要求网站只能有限制的访问外部网站的资源，不合法的请求会被拦截。网站的源由协议、域名、端口三部分组成，有一部分不同就被视为不同源，两个不同的域名即便指向同一个ip地址也是跨域的。网站通过AJAX请求资源是典型的跨域请求，需要外部网站许可才能访问。</p>
<p>同源策略是浏览器端的安全限制。</p>
<a id="more"></a>
<p><img src="/assets/images/15178986212867.jpg" alt=""></p>
<blockquote>
<p>“Domains, protocols and ports must match”</p>
</blockquote>
<h1 id="跨域对前端的影响"><a href="#跨域对前端的影响" class="headerlink" title="跨域对前端的影响"></a>跨域对前端的影响</h1><ul>
<li>AJAX：请求无法发送和接收</li>
<li>WebFonts：字体文件无法从别的域加载</li>
<li>SVG：通过use引用的外部资源无法使用</li>
<li>Canvas/WebGL：如无法读取图片的点阵数据，无法toDateURL等</li>
<li>Video：无法截取快照</li>
</ul>
<p>通常浏览器控制台会明确打印出跨域错误及其帮助信息，如：</p>
<p><img src="/assets/images/15178986972043.jpg" alt=""></p>
<h1 id="CORS的浏览器支持"><a href="#CORS的浏览器支持" class="headerlink" title="CORS的浏览器支持"></a>CORS的浏览器支持</h1><p><img src="/assets/images/15178987236463.jpg" alt=""></p>
<p>基本主流浏览器都已经支持。</p>
<h1 id="跨域请求过程"><a href="#跨域请求过程" class="headerlink" title="跨域请求过程"></a>跨域请求过程</h1><p><img src="/assets/images/15178987563714.jpg" alt=""></p>
<ol>
<li>首先查看http头部有无origin字段；</li>
<li>如果没有，或者不允许，直接当成普通请求处理，结束；</li>
<li>如果有并且是允许的，那么再看是否是preflight(method=OPTIONS)；</li>
<li>如果是preflight，就返回Allow-Headers、Allow-Methods等，内容为空；</li>
<li>如果不是preflight，就返回Allow-Origin、Allow-Credentials等，并返回正常内容。</li>
</ol>
<h2 id="简单请求-Simple-Request"><a href="#简单请求-Simple-Request" class="headerlink" title="简单请求(Simple Request)"></a>简单请求(Simple Request)</h2><p>GET, HEAD, POST 方法，并且POST方法的Content-Type只包含 text/plain, application/x-www-form-urlencoded, multipart/form-data</p>
<h2 id="预请求-Preflighted-Request"><a href="#预请求-Preflighted-Request" class="headerlink" title="预请求(Preflighted Request)"></a>预请求(Preflighted Request)</h2><p>在简单请求之外的其它请求发出前，都会先发一个OPTION请求，以探测服务器是否支持及允许CORS请求的配置参数。</p>
<blockquote>
<p>我们的大多数AJAX请求包含Authentication头，因此这些都不会是简单请求，所有请求都需要先发一个预请求。</p>
</blockquote>
<h1 id="跨域相关HTTP-Headers"><a href="#跨域相关HTTP-Headers" class="headerlink" title="跨域相关HTTP Headers"></a>跨域相关HTTP Headers</h1><h2 id="相关Headers介绍"><a href="#相关Headers介绍" class="headerlink" title="相关Headers介绍"></a>相关Headers介绍</h2><p><img src="/assets/images/15179074088703.jpg" alt=""></p>
<ul>
<li>请求头都是由浏览器自动生成的，根据请求的不是当前域进行判断。</li>
<li>服务器端需要支持OPTION请求，并返回204</li>
<li>其它请求服务器端需要添加http headers即可，所有验证逻辑均在浏览器端完成。</li>
</ul>
<h2 id="支持Cookies的跨域"><a href="#支持Cookies的跨域" class="headerlink" title="支持Cookies的跨域"></a>支持Cookies的跨域</h2><p>若接口（比如<a href="http://api.com/ping）需要在自己域（http://api.com）下读写Cookies" target="_blank" rel="noopener">http://api.com/ping）需要在自己域（http://api.com）下读写Cookies</a>, 在没有 <code>Access-Control-Allow-Credentials: true</code> 的请求中，Cookies是不支持的，即 接口不能够读写域下的Cookies 。</p>
<p>因此要支持Cookies的跨域，需要服务器端返回如下头：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> <span class="string">OPTION</span> <span class="string">Request</span></span><br><span class="line"><span class="string">OPTIONS</span> <span class="string">/api/v1/captcha?deviceId=web20180110_71007&amp;platform=desktop-web&amp;env=Chrome&amp;vendor=web&amp;lang=&amp;appVer=4.0.0</span> <span class="string">HTTP/1.1</span></span><br><span class="line"><span class="attr">Host:</span> <span class="string">test-oauth.itiger.com</span></span><br><span class="line"><span class="attr">Access-Control-Request-Method:</span> <span class="string">GET</span></span><br><span class="line"><span class="attr">Origin:</span> <span class="attr">https://test-web.itiger.com</span></span><br><span class="line"><span class="attr">Access-Control-Request-Headers:</span> <span class="string">authorization</span></span><br><span class="line"><span class="attr">Accept:</span> <span class="string">*/*</span></span><br><span class="line"><span class="attr">Accept-Encoding:</span> <span class="string">gzip,</span> <span class="string">deflate,</span> <span class="string">br</span></span><br><span class="line"><span class="attr">Accept-Language:</span> <span class="string">zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">OPTION</span> <span class="string">Response</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">204</span> <span class="literal">No</span> <span class="string">Content</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Wed,</span> <span class="number">10</span> <span class="string">Jan</span> <span class="number">2018</span> <span class="number">09</span><span class="string">:13:22</span> <span class="string">GMT</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">text/plain</span> <span class="string">charset=UTF-8</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">Server:</span> <span class="string">nginx/1.9.6</span></span><br><span class="line"><span class="attr">Access-Control-Allow-Origin:</span> <span class="attr">https://test-web.itiger.com</span></span><br><span class="line"><span class="attr">Access-Control-Allow-Credentials:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">Access-Control-Allow-Methods:</span> <span class="string">POST,</span> <span class="string">GET,</span> <span class="string">OPTIONS,</span> <span class="string">HEAD,</span> <span class="string">DELETE,</span> <span class="string">PUT</span></span><br><span class="line"><span class="attr">Access-Control-Allow-Headers:</span> <span class="string">DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">GET</span> <span class="string">Request</span></span><br><span class="line"><span class="string">GET</span> <span class="string">/api/v1/captcha?deviceId=web20180110_71007&amp;platform=desktop-web&amp;env=Chrome&amp;vendor=web&amp;lang=&amp;appVer=4.0.0</span> <span class="string">HTTP/1.1</span></span><br><span class="line"><span class="attr">Host:</span> <span class="string">test-oauth.itiger.com</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Accept:</span> <span class="string">application/json,</span> <span class="string">text/plain,</span> <span class="string">*/*</span></span><br><span class="line"><span class="attr">Origin:</span> <span class="attr">https://test-web.itiger.com</span></span><br><span class="line"><span class="attr">Authorization:</span> <span class="string">Bearer</span> <span class="string">gMnH2uCUzsoncdiC90XJaYDpoYgxDYiBMydIUGfC9NDkfSiiD0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">GET</span> <span class="string">Response</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Wed,</span> <span class="number">10</span> <span class="string">Jan</span> <span class="number">2018</span> <span class="number">09</span><span class="string">:16:19</span> <span class="string">GMT</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">application/json</span></span><br><span class="line"><span class="attr">Transfer-Encoding:</span> <span class="string">chunked</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">Vary:</span> <span class="string">Accept-Encoding</span></span><br><span class="line"><span class="attr">Server:</span> <span class="string">TornadoServer/3.2.2</span></span><br><span class="line"><span class="attr">Etag:</span> <span class="string">W/"d8b94d7da2b3d9cec8a195d024dea7147a470d4b"</span></span><br><span class="line"><span class="attr">Pragma:</span> <span class="literal">no</span><span class="bullet">-store</span></span><br><span class="line"><span class="attr">Cache-Control:</span> <span class="literal">no</span><span class="bullet">-store</span></span><br><span class="line"><span class="attr">Set-Cookie:</span> <span class="string">captcha="2|1:0|10:1515575779|7:captcha|88:NDdkNmYzYjYwMzQ5N2ViNTU0YjQ0YmEyNTY3MDVjZmVkMWNmZTc1ODRmNzNiNGNjN2M1Yzc5Mzg4MjE0YTg3Yg==|7fe5bc2d6d748af5fd3442a09ad07f8d819db249e0c13d1047e1411611e25878";</span> <span class="string">expires=Fri,</span> <span class="number">09</span> <span class="string">Feb</span> <span class="number">2018</span> <span class="number">09</span><span class="string">:16:19</span> <span class="string">GMT;</span> <span class="string">Path=/</span></span><br><span class="line"><span class="attr">Access-Control-Allow-Origin:</span> <span class="attr">https://test-web.itiger.com</span></span><br><span class="line"><span class="attr">Access-Control-Allow-Credentials:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">Access-Control-Allow-Methods:</span> <span class="string">POST,</span> <span class="string">GET,</span> <span class="string">OPTIONS,</span> <span class="string">HEAD,</span> <span class="string">DELETE,</span> <span class="string">PUT</span></span><br><span class="line"><span class="attr">Access-Control-Allow-Headers:</span> <span class="string">Referer,Accept,Origin,User-Agent,Authorization,NT,X-CustomHeader,Keep-Alive,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Connection,DNT</span></span><br><span class="line"><span class="attr">Content-Encoding:</span> <span class="string">gzip</span></span><br></pre></td></tr></table></figure></p>
<p>除此之外，前端在进行请求时需要特别标注：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Vanilla</span></span><br><span class="line"><span class="keyword">let</span> xhr = <span class="keyword">new</span> XMLHttpRequest()</span><br><span class="line">xhr.withCredentials = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// JQuery</span></span><br><span class="line">$.ajax(&#123;</span><br><span class="line">    type: <span class="string">'POST'</span>,</span><br><span class="line">    data: &#123;&#125;,</span><br><span class="line">    dataType: <span class="string">'json'</span>,</span><br><span class="line">    xhrFields: &#123;</span><br><span class="line">       withCredentials: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue-resource</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">this</span>.$http.get(url, &#123;</span><br><span class="line">  credentials: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h1 id="调试CORS请求问题"><a href="#调试CORS请求问题" class="headerlink" title="调试CORS请求问题"></a>调试CORS请求问题</h1><p>主要有两种方法：</p>
<h2 id="简单判定是否CORS问题，"><a href="#简单判定是否CORS问题，" class="headerlink" title="简单判定是否CORS问题，"></a>简单判定是否CORS问题，</h2><ol>
<li>查看控制台出错日志信息</li>
<li>下载 <a href="https://chrome.google.com/webstore/detail/nlfbmbojpeacfghkpbjhddihlkkiljbi" target="_blank" rel="noopener">CORS 调试</a>  浏览器插件，开启后重新请求</li>
</ol>
<p><img src="/assets/images/15179075649303.jpg" alt=""></p>
<blockquote>
<p>注意：<br>开启并用默认配置(<em>://</em>)，可能会导致某些网站访问异常，如GitHub。建议自行添加过滤。<br>此种方法也适用于开发时调用暂未配置跨域的接口。</p>
</blockquote>
<h2 id="用Charles修改HTTP请求调试"><a href="#用Charles修改HTTP请求调试" class="headerlink" title="用Charles修改HTTP请求调试"></a>用Charles修改HTTP请求调试</h2><h1 id="Nginx-配置参考"><a href="#Nginx-配置参考" class="headerlink" title="Nginx 配置参考"></a>Nginx 配置参考</h1><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">map</span> <span class="variable">$http_origin</span> <span class="variable">$allow_origin</span> &#123;</span><br><span class="line">  <span class="attribute">default</span> <span class="string">""</span>;</span><br><span class="line">  "~^https?://(?:[^/]*\.)?(stevebuzonas\.(?:com|local))(?::[0-9]+)?$" "$http_origin";</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">map</span> <span class="variable">$request_method</span> <span class="variable">$cors_method</span> &#123;</span><br><span class="line">  <span class="attribute">default</span> <span class="string">"allowed"</span>;</span><br><span class="line">  "OPTIONS" "preflight";</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">map</span> <span class="variable">$cors_method</span> <span class="variable">$cors_max_age</span> &#123;</span><br><span class="line">  <span class="attribute">default</span> <span class="string">""</span>;</span><br><span class="line">  "preflight" 1728000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">map</span> <span class="variable">$cors_method</span> <span class="variable">$cors_allow_methods</span> &#123;</span><br><span class="line">  <span class="attribute">default</span> <span class="string">""</span>;</span><br><span class="line">  "preflight" "GET, POST, OPTIONS";</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">map</span> <span class="variable">$cors_method</span> <span class="variable">$cors_allow_headers</span> &#123;</span><br><span class="line">  <span class="attribute">default</span> <span class="string">""</span>;</span><br><span class="line">  "preflight" "Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since,Authorization";</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">map</span> <span class="variable">$cors_method</span> <span class="variable">$cors_content_length</span> &#123;</span><br><span class="line">  <span class="attribute">default</span> <span class="variable">$initial_content_length</span>;</span><br><span class="line">  "preflight" 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">map</span> <span class="variable">$cors_method</span> <span class="variable">$cors_content_type</span> &#123;</span><br><span class="line">  <span class="attribute">default</span> <span class="variable">$initial_content_type</span>;</span><br><span class="line">  "preflight" "text/plain charset=UTF-8";</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">add_header</span> Access-Control-Allow-Origin <span class="variable">$allow_origin</span> always;</span><br><span class="line"><span class="attribute">add_header</span> Access-Control-Allow-Credentials <span class="string">'true'</span> always;</span><br><span class="line"><span class="attribute">add_header</span> Access-Control-Max-Age <span class="variable">$cors_max_age</span> always;</span><br><span class="line"><span class="attribute">add_header</span> Access-Control-Allow-Methods <span class="variable">$cors_allow_methods</span> always;</span><br><span class="line"><span class="attribute">add_header</span> Access-Control-Allow-Headers <span class="variable">$cors_allow_headers</span> always;</span><br><span class="line"></span><br><span class="line"><span class="attribute">set</span> <span class="variable">$initial_content_length</span> <span class="variable">$sent_http_content_length</span>;</span><br><span class="line"><span class="attribute">add_header</span> <span class="string">'Content-Length'</span> <span class="string">""</span>;</span><br><span class="line"><span class="attribute">add_header</span> <span class="string">'Content-Length'</span> <span class="variable">$cors_content_length</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">set</span> <span class="variable">$initial_content_type</span> <span class="variable">$sent_http_content_type</span>;</span><br><span class="line"><span class="attribute">add_header</span> Content-Type <span class="string">""</span>;</span><br><span class="line"><span class="attribute">add_header</span> Content-Type <span class="variable">$cors_content_type</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$request_method</span> = <span class="string">'OPTIONS'</span>) &#123;</span><br><span class="line">  <span class="attribute">return</span> <span class="number">204</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ol>
<li>相关Access-Control的add_header后加了<code>always</code>，因为默认情况下，<code>add_header</code>只作用于状态码为 200, 201 (1.3.10), 204, 206, 301, 302, 303, 304, 307 (1.1.16, 1.0.13), or 308 (1.13.0) 之中的响应，并不支持40x,50x等，因此添加<code>always</code>可以支持所有状态码。 见：<a href="http://nginx.org/en/docs/http/ngx_http_headers_module.html#add_header" target="_blank" rel="noopener">http://nginx.org/en/docs/http/ngx_http_headers_module.html#add_header</a></li>
<li>之所以用<code>map</code>命令而不是<code>if</code>，是由于if其实是归属于nginx_rewrite模块的，对于<code>try_files</code>等会不支持，Nginx官方也并不建议使用<code>if</code>。见：<a href="https://www.nginx.com/resources/wiki/start/topics/depth/ifisevil/" target="_blank" rel="noopener">https://www.nginx.com/resources/wiki/start/topics/depth/ifisevil/</a></li>
<li>以上<code>nginx-cors.conf</code>可如下方式使用：<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">  <span class="attribute">include</span> ./nginx-cors.conf;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attribute">proxy_pass</span> http://127.0.0.1:4000;</span><br><span class="line">  <span class="attribute">proxy_set_http_header</span> HOST <span class="variable">$http_host</span>;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h1><ul>
<li><a href="https://www.w3.org/TR/cors/" target="_blank" rel="noopener">https://www.w3.org/TR/cors/</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS</a></li>
<li><a href="https://www.test-cors.org/" target="_blank" rel="noopener">https://www.test-cors.org/</a></li>
<li><a href="https://enable-cors.org/index.html" target="_blank" rel="noopener">https://enable-cors.org/index.html</a></li>
<li><a href="https://www.html5rocks.com/en/tutorials/cors/" target="_blank" rel="noopener">https://www.html5rocks.com/en/tutorials/cors/</a><h1 id="扩展知识"><a href="#扩展知识" class="headerlink" title="扩展知识"></a>扩展知识</h1></li>
<li>HTTPS</li>
<li>Nginx</li>
<li>CSP</li>
<li>HTTP/1.1 vs HTTP2</li>
</ul>
            

        </div>
    </div>
    
    <div id="post-footer" class="post-footer main-content-wrap">
        <div>
  <ul class="post-copyright">
    <li class="post-copyright-link">
      <strong>本文作者：</strong> ijse
      <a href="/" title="欢迎访问 TigerFED">@TigerFED</a>
    </li>

    <li class="post-copyright-link">
      <strong>本文标题：</strong>
      <a href="http://tigerbrokers.github.io/about-cors-and-nginx/"title="有关跨域 CORS 及 Nginx 配置">有关跨域 CORS 及 Nginx 配置</a>
    </li>

    <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://tigerbrokers.github.io/about-cors-and-nginx/" title="有关跨域 CORS 及 Nginx 配置">http://tigerbrokers.github.io/about-cors-and-nginx/</a>
    </li>

    <li class="post-copyright-date">
      <strong>发布时间：</strong> 2018年2月6日 06时02分
    </li>

    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本文由 TigerFED 原创，采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="license" target="_blank">保留署名-非商业性使用-禁止演绎 4.0-国际许可协议</a> </br>转载请保留以上声明信息！
    </li>
  </ul>
</div>

        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">标签</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/cors/">cors</a> <a class="tag tag--primary tag--small t-link" href="/tags/http/">http</a> <a class="tag tag--primary tag--small t-link" href="/tags/nginx/">nginx</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/about-data-visiualization/" data-tooltip="有关数据可视化学习" aria-label="上一篇: 有关数据可视化学习">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="post.share">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="post.back_to_top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
    
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2018 TigerFED. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/about-data-visiualization/" data-tooltip="有关数据可视化学习" aria-label="上一篇: 有关数据可视化学习">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="post.share">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="post.back_to_top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="4">
    <i id="btn-close-shareoptions" class="fa fa-close"></i>
    <ul class="share-options">
        
    </ul>
</div>

            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/tfed.png" alt="作者的图片"/>
        
            <h4 id="about-card-name">TigerFED</h4>
        
            <div id="about-card-bio"><p>老虎证券桌面团队博客</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p><a href="/joinus">加入我们</a></p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                <p>北京</p>

            </div>
        
        
    </div>
</div>

        
            <div id="algolia-search-modal" class="modal-container">
    <div class="modal">
        <div class="modal-header">
            <span class="close-button"><i class="fa fa-close"></i></span>
            <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
                <span class="searchby-algolia-text text-color-light text-small">by</span>
                <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
            </a>
            <i class="search-icon fa fa-search"></i>
            <form id="algolia-search-form">
                <input type="text" id="algolia-search-input" name="search"
                    class="form-control input--large search-input" placeholder="Search "
                    />
            </form>
        </div>
        <div class="modal-body">
            <div class="no-result text-color-light text-center">没有找到文章</div>
            <div class="results">
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://tigerbrokers.github.io/about-cors-and-nginx/">
                            <h3 class="media-heading">有关跨域 CORS 及 Nginx 配置</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2018年2月6日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>跨域请求针对浏览器的同源策略(Same-Origin Policy)而言，指一个网站主动请求另外一个网站的资源(图片、javascript、视频等)。</p>
<p>同源策略要求网站只能有限制的访问外部网站的资源，不合法的请求会被拦截。网站的源由协议、域名、端口三部分组成，有一部分不同就被视为不同源，两个不同的域名即便指向同一个ip地址也是跨域的。网站通过AJAX请求资源是典型的跨域请求，需要外部网站许可才能访问。<br></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://tigerbrokers.github.io/about-data-visiualization/">
                            <h3 class="media-heading">有关数据可视化学习</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2018年2月7日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>数据可视化（Data Visualization）和 信息可视化（Information Visualization）是两个相近的专业领域名词。狭义上的数据可视化指的是将数据用统计图表方式呈现，而信息可视化则是将非数字的信息进行可视化。前者用于传递信息，后者用于表现抽象或复杂的概念、技术和信息。而广义上的数据可视化则是数据可视化、信息可视化以及科学可视化等等多个领域的统称。<br></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
            </div>
        </div>
        <div class="modal-footer">
            <p class="results-count text-medium"
                data-message-zero="没有找到文章"
                data-message-one="找到 1 篇文章"
                data-message-other="找到 {n} 篇文章">
                找到 2 篇文章
            </p>
        </div>
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/bg-city.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-mujnsfe7iyzs9uzb9yneddtzhobg1rrfva8tc3jxzzvgh875skcuap5a4jen.min.js"></script>
<!--SCRIPTS END-->

    


    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment-with-locales.min.js"></script>
    <script src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
    <script>
        var algoliaClient = algoliasearch('HI0N3S0FZG', 'e0fcd80da1f0bfdfda78788ddb3bc0d7');
        var algoliaIndex = algoliaClient.initIndex('tranquilpeak');
    </script>


    </body>
</html>
